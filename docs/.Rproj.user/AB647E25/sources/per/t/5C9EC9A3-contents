---
title: "Cantidad de personas por zona o localidad"
author: "Diego Medina"
date: "11/10/2020"
output:
    html_document:
      theme: simplex
---
# Paquetes y preparación de datos espaciales
Estos son los paquetes o librerías que vamos a ocupar para poder hacer el análisis de los datos. Cada una se puede buscar en la pestaña *help* a la derecha de ***Rstudio***.
```{r,echoe=FALSE,message=FALSE,warnings=FALSE}
library(rgdal)
library(DBI)
library(dplyr)
library(raster)
library(sf)
library(maptools)
library(rgeos)
options(scipen=999)
```

### Preparación datos espaciales

```{r,warnings=FALSE,message=FALSE,echoe=FALSE}
Zonas_urbanas <- readShapePoly('R10/ZONA_C17.shp', IDvar=NULL)
Localidades_rurales <- readShapePoly('R10/LOCALIDAD_C17.shp', IDvar=NULL)

names(Zonas_urbanas) ### Se ven las columnas de la data
names(Localidades_rurales)
```

### Filtrar por comuna en los datos espaciales

Para filtrar por comuna en el *.shp* hay que primero saber qué código es cada comuna según las cartografías del INE. Para consultar el manual del censista en este repositorio [click aquí](https://github.com/demcortillas/CENSO2017/blob/main/Manual_para-Censistas.pdf)

```{r}
PtoV_urb <- subset(Zonas_urbanas,COMUNA == 10109)
PtoV_rur <- subset(Localidades_rurales,COMUNA == 10109)

```

### Juntar los dos .shp

```{r}
Pto_varas_sp <- bind(PtoV_urb, PtoV_rur)
```

## Trabando con los Microdatos

Conexión con la base de datos y conexión con la tabla de personas

```{r}
con <- dbConnect(RSQLite::SQLite(), "D:/PROJECTS/db/CENSO2017/microdatos/MVE.db") 
DB <- tbl(con, "PERSONAS")
```

### Filtrar por microdatos de comuna

```{r}
Pto_varas <- DB %>% filter(COMUNA==10109) %>% collect()
```

### ¿cuántas personas hay por zona o por localidad?

```{r}
GEOCODIGO<-unique(Pto_varas$ID_ZONA_LOC)
CANT_PER<-NULL

for(localidad in unique(Pto_varas$ID_ZONA_LOC)){
  A<-subset(Pto_varas,ID_ZONA_LOC == localidad)
  CANT_PER<-c(CANT_PER,dim(A)[1])
}

data<-data.frame(GEOCODIGO=as.character(GEOCODIGO),CANT_PER)

hist(data$CANT_PER,xlab='Cantidad personas')
```

### cruzar la data no espacial con la espacial mediante columna GEOCODIGO

```{r}
Pto_varas<-merge(x=Pto_varas_sp,y=data,by.x="GEOCODIGO",by.y="GEOCODIGO")
```

### Exportar en formato .shp

```{r}
writeOGR(obj=Pto_varas, dsn="out", layer="Pto_varas", driver="ESRI Shapefile",overwrite_layer=TRUE)
```

# Discusión metodológica

A este nivel de agregación podemos trabajar con el cruce de variables que querramos. Pero existe un segundo método bastante importante. Mediante el siguiente *.shp* podemos acceder a la cantidad de personas a nivel de entidad rural y podemos comparar las densidades. La entidad es un nivel más desagregado equivalente a la manzana censal pero a nivel rural, pero que solamente puedes acceder a la cantidad de personas o viviendas que viven ahí y no se puede cruzar con ninguna otra variable porque el ine no facilita los datos

```{r,warnings=FALSE,message=FALSE,echoe=FALSE}

Entidades<- shapefile('R10/ENTIDAD_IND_C17.shp')
Entidad_pto_varas <- subset(Entidades,COMUNA == 10109)
Entidad_pto_varas <- spTransform(Entidad_pto_varas, crs("+init=epsg:32719"))

```


```{r}
densidad <- Entidad_pto_varas@data$TOTAL_PERS / (area(Entidad_pto_varas)/10000)
hist(densidad,xlab='cantidad personas por ha')
hist(log(densidad),xlab='cantidad personas por ha')

```

Entonces tienes las ***ENTIDADES*** con su respectiva densidad o puedes tener las ***LOCALIDADES*** para cualquier otro cruce de variables disponibles en el censo. Para más información de las bases de datos del censo y cómo estas funcionan [click aquí](https://github.com/demcortillas/CENSO2017).


